<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HealthyStudySpace AI: –ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞ –¥–ª—è –æ—á–µ–π</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

  <style>
    /* --- –°–¢–ò–õ–Ü –¢–ê –î–ò–ó–ê–ô–ù --- */
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #75cfca, #59b7b2);
      text-align: center; margin: 0; padding: 0;
      color: #333; overflow-x: hidden; min-height: 100vh;
    }

    h2 { margin-top: 20px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    .container {
      margin-top: 20px; display: inline-block;
      background: rgba(255, 255, 255, 0.9); padding: 20px;
      border-radius: 20px; backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative;
      visibility: hidden; 
    }

    canvas { border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); max-width: 100%; height: auto; }

    #status { margin-top: 15px; font-size: 1.3em; font-weight: 600; padding: 10px; border-radius: 10px; }
    #status.good { color: #2e7d32; background: #e8f5e9; }
    #status.bad { color: #c62828; background: #ffebee; }
    #status.neutral { color: #555; background: #f5f5f5; }

    /* --- –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê --- */
    .modal {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: white;
      padding: 25px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      text-align: left; width: 360px; z-index: 1000; animation: popIn 0.3s ease-out;
    }
    #settings-modal { display: block; }

    @keyframes popIn { from { transform: translate(-50%, -60%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }

    .modal h3 { margin-top: 0; text-align: center; color: #00796b; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .modal h4 { margin: 15px 0 5px 0; color: #004d40; font-size: 1.1em; }
    .input-row { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    input[type="number"] { padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 60px; }
    select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
    
    .btn { width: 100%; margin-top: 15px; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; }
    .btn-primary { background: #00796b; color: white; }
    .btn-primary:hover { background: #004d40; }
    .btn-close { background: #eee; color: #333; }
    .btn-action { background: #00796b; color: white; width: auto; margin: 0; }

    #overlay { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 999; }
    
    /* --- –ï–ö–†–ê–ù –í–ü–†–ê–í --- */
    #exercise-screen {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #75cfca, #59b7b2); z-index: 2000;
      flex-direction: column; justify-content: center; align-items: center; overflow-y: auto;
    }
    .slider-container { position: relative; display: flex; align-items: center; justify-content: center; width: 100%; max-width: 850px; }
    .exercise-card { background: white; width: 90%; max-width: 600px; border-radius: 20px; padding: 30px; text-align: center; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .exercise-card.active { display: block; animation: slideUp 0.4s ease-out; }
    
    .nav-btn { background: rgba(255,255,255,0.3); border: none; color: white; font-size: 2.5rem; cursor: pointer; padding: 20px; border-radius: 50%; transition: 0.3s; margin: 0 10px; user-select: none; }
    .nav-btn:hover { background: rgba(255,255,255,0.5); }

    .instruction-text { font-size: 1.1em; color: #444; background: #e0f2f1; padding: 15px; border-radius: 10px; margin: 20px 0; line-height: 1.5; }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

<h2>HealthyStudySpace AI</h2>

<div class="container" id="main-container">
  <canvas id="canvas"></canvas>
  <div id="status" class="neutral">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è...</div>
</div>

<div id="overlay"></div>

<div id="settings-modal" class="modal">
  <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
  <h4>‚è∞ –¢–∞–π–º–µ—Ä —Ä–æ–∑–º–∏–Ω–∫–∏</h4>
  <div class="input-row">
    <span>–ù–∞–≥–∞–¥—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑:</span>
    <div>
      <input type="number" id="timeValue" value="10" min="1">
      <select id="timeUnit"><option value="sec">–°–µ–∫</option><option value="min">–•–≤</option></select>
    </div>
  </div>
  <div class="input-row">
    <label><input type="checkbox" id="loopCheck" checked> <span style="margin-left:8px;">–ü–æ—Å—Ç—ñ–π–Ω–∏–π —Ü–∏–∫–ª</span></label>
  </div>
  <hr style="border:0; border-top:1px solid #eee;">
  <h4>‚ö†Ô∏è –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Å—Ç–∞–≤–∏</h4>
  <div class="input-row">
    <span>–ß–∞—Å –¥–æ —Å–∏–≥–Ω–∞–ª—É (—Å–µ–∫):</span>
    <input type="number" id="postureDelayInput" value="5" min="1">
  </div>
  <div class="input-row">
    <label><input type="checkbox" id="postureSoundCheck" checked> <span style="margin-left:8px;">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ –ø–æ–º–∏–ª–∫–∏</span></label>
  </div>
  <button class="btn btn-primary" onclick="startSystem()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
</div>

<div id="popup-reminder" class="modal">
  <h3 style="text-align:center">üîî –ß–∞—Å —Ä–æ–∑—ñ–º'—è—Ç–∏—Å—å!</h3>
  <p style="text-align:center">–í–∏ –ø—Ä–∞—Ü—é—î—Ç–µ –≤–∂–µ –¥–æ–≤–≥–æ.<br>–ó—Ä–æ–±—ñ—Ç—å –≤–ø—Ä–∞–≤–∏ –¥–ª—è –æ—á–µ–π.</p>
  <div style="display:flex; justify-content: center; gap: 10px; margin-top: 15px;">
      <button class="btn btn-close" style="width:auto; margin:0;" onclick="closeReminder()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
      <button class="btn btn-action" style="width:auto; margin:0;" onclick="goToExercises()">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≤–ø—Ä–∞–≤</button>
  </div>
</div>

<div id="exercise-screen">
  <div class="slider-container">
    <button class="nav-btn" onclick="changeExercise(-1)">‚ùÆ</button>

    <div class="exercise-card active" id="ex1">
      <h3 style="color:#00796b">–í–ø—Ä–∞–≤–∞ 1: –ß–∞—Å—Ç–µ –∫–ª—ñ–ø–∞–Ω–Ω—è</h3>
      <video width="100%" height="auto" controls loop id="vid1">
        <source src="Blink_eyes.mp4" type="video/mp4">
      </video>
      <div class="instruction-text">
        –®–≤–∏–¥–∫–æ —ñ –ª–µ–≥–∫–æ –∫–ª—ñ–ø–∞–π—Ç–µ –æ—á–∏–º–∞ –ø—Ä–æ—Ç—è–≥–æ–º 1-2 —Ö–≤–∏–ª–∏–Ω.<br>
        –¶–µ –ø–æ–∫—Ä–∞—â—É—î –∫—Ä–æ–≤–æ–æ–±—ñ–≥ —ñ –∑–≤–æ–ª–æ–∂—É—î –æ—á—ñ.
      </div>
      <button class="btn btn-primary" onclick="finishExercises()">‚úÖ –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
    </div>

    <div class="exercise-card" id="ex2">
      <h3 style="color:#00796b">–í–ø—Ä–∞–≤–∞ 2: –ú—ñ—Ü–Ω–µ –∑–∞–ø–ª—é—â–µ–Ω–Ω—è</h3>
      <video width="100%" height="auto" controls loop id="vid2">
        <source src="Long_blind.mp4" type="video/mp4">
      </video>
      <div class="instruction-text">
        –ú—ñ—Ü–Ω–æ –∑–∞–ø–ª—é—â—Ç–µ –æ—á—ñ –Ω–∞ 3-5 —Å–µ–∫—É–Ω–¥, –ø–æ—Ç—ñ–º –≤—ñ–¥–∫—Ä–∏–π—Ç–µ.<br>
        –î–æ–ø–æ–º–∞–≥–∞—î –∑–Ω—è—Ç–∏ –Ω–∞–ø—Ä—É–≥—É –∑ –æ—á–Ω–∏—Ö –º'—è–∑—ñ–≤.
      </div>
      <button class="btn btn-primary" onclick="finishExercises()">‚úÖ –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
    </div>

    <div class="exercise-card" id="ex3">
      <h3 style="color:#00796b">–í–ø—Ä–∞–≤–∞ 3: –†—É—Ö –æ—á–∏–º–∞</h3>
      <video width="100%" height="auto" controls loop id="vid3">
        <source src="moving_eye.mp4" type="video/mp4">
      </video>
      <div class="instruction-text">
        –ü–æ–≤—ñ–ª—å–Ω–æ —Ä—É—Ö–∞–π—Ç–µ –æ—á–∏–º–∞ –≤–≥–æ—Ä—É-–≤–Ω–∏–∑ —Ç–∞ –≤–ª—ñ–≤–æ-–≤–ø—Ä–∞–≤–æ.<br>
        –¶–µ —Ç—Ä–µ–Ω—É—î –æ—á–Ω—ñ –º'—è–∑–∏ —Ç–∞ –∑–Ω—ñ–º–∞—î –≤—Ç–æ–º—É.
      </div>
      <button class="btn btn-primary" onclick="finishExercises()">‚úÖ –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
    </div>

    <button class="nav-btn" onclick="changeExercise(1)">‚ùØ</button>
  </div>
</div>

<script>
// --- –ö–û–ù–°–¢–ê–ù–¢–ò –¢–ê –õ–û–ì–Ü–ö–ê (–í–º–æ–Ω—Ç–æ–≤–∞–Ω–æ —Å–∏—Å—Ç–µ–º—É MediaPipe) ---
let reminderIntervalMs, isLooping, badPostureDelayMs, isPostureSoundEnabled;
let pose, camera, videoElement;
let badPostureStart = null;
let timerId = null;
let currentEx = 1;
const totalExercises = 3;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");
const alarmSound = new Audio("https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg");
const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

async function startSystem() {
  const val = parseInt(document.getElementById('timeValue').value);
  const unit = document.getElementById('timeUnit').value;
  isLooping = document.getElementById('loopCheck').checked;
  reminderIntervalMs = (unit === 'min') ? val * 60 * 1000 : val * 1000;
  badPostureDelayMs = parseInt(document.getElementById('postureDelayInput').value) * 1000;
  isPostureSoundEnabled = document.getElementById('postureSoundCheck').checked;

  document.getElementById('settings-modal').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('main-container').style.visibility = 'visible';

  initAI();
}

function initAI() {
  statusText.textContent = "üöÄ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AI...";
  videoElement = document.createElement('video');

  pose = new Pose({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
  });

  pose.setOptions({
    modelComplexity: 0,
    smoothLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults(onResults);

  camera = new Camera(videoElement, {
    onFrame: async () => { await pose.send({image: videoElement}); },
    width: 640, height: 480
  });
  
  camera.start().then(() => {
    statusText.textContent = "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞";
    startReminderTimer();
  });
}

function onResults(results) {
  canvas.width = results.image.width;
  canvas.height = results.image.height;
  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  const isReminderOpen = document.getElementById('popup-reminder').style.display === 'block';
  const isExerciseOpen = document.getElementById('exercise-screen').style.display === 'flex';

  // –í—ñ–¥—Å—Ç–µ–∂—É—î–º–æ –ø–æ—Å—Ç–∞–≤—É —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –µ–∫—Ä–∞–Ω–∏ –≤–ø—Ä–∞–≤ –∑–∞–∫—Ä–∏—Ç—ñ
  if (results.poseLandmarks && !isReminderOpen && !isExerciseOpen) {
    analyzePosture(results.poseLandmarks);
    drawSkeleton(results.poseLandmarks);
  }
  ctx.restore();
}

function analyzePosture(landmarks) {
  const leftShoulder = landmarks[11];
  const rightShoulder = landmarks[12];
  const nose = landmarks[0];
  let posture = "neutral";

  if (leftShoulder.visibility > 0.5 && rightShoulder.visibility > 0.5) {
    const diffY = Math.abs(leftShoulder.y - rightShoulder.y);
    const shouldersOK = diffY < 0.035; 
    let headOK = true;
    if (nose.visibility > 0.5) {
      const avgShoulderX = (leftShoulder.x + rightShoulder.x) / 2;
      headOK = Math.abs(nose.x - avgShoulderX) < 0.15;
    }
    posture = (shouldersOK && headOK) ? "good" : "bad";
  }

  if (posture === "bad") {
    if (!badPostureStart) badPostureStart = Date.now();
    if (Date.now() - badPostureStart > badPostureDelayMs) {
      if (isPostureSoundEnabled) beep.play().catch(()=>{});
    }
  } else { badPostureStart = null; }

  updateStatusUI(posture);
}

function updateStatusUI(posture) {
  let newText = "", newClass = "";
  if (posture === "good") { newText = "‚úÖ –ß—É–¥–æ–≤–∞ –ø–æ—Å—Ç–∞–≤–∞!"; newClass = "good"; }
  else if (posture === "bad") { newText = "‚ö†Ô∏è –í–∏—Ä—ñ–≤–Ω—è–π—Ç–µ —Å–ø–∏–Ω—É!"; newClass = "bad"; }
  else { newText = "ü§î –ù–µ –±–∞—á—É –ø–ª–µ—á–µ–π"; newClass = "neutral"; }

  if (statusText.className !== newClass) {
    statusText.textContent = newText;
    statusText.className = newClass;
  }
}

function drawSkeleton(landmarks) {
  const L = landmarks[11], R = landmarks[12];
  if (L.visibility > 0.5 && R.visibility > 0.5) {
    ctx.beginPath();
    ctx.moveTo(L.x * canvas.width, L.y * canvas.height);
    ctx.lineTo(R.x * canvas.width, R.y * canvas.height);
    ctx.lineWidth = 6;
    ctx.strokeStyle = statusText.className === "good" ? "#00e676" : "#ff1744";
    ctx.stroke();
  }
}

// --- –¢–ê–ô–ú–ï–†–ò –¢–ê –í–ü–†–ê–í–ò ---
function startReminderTimer() {
  if (timerId) clearTimeout(timerId);
  timerId = setTimeout(() => {
    badPostureStart = null;
    document.getElementById('popup-reminder').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
    alarmSound.play().catch(()=>{});
  }, reminderIntervalMs);
}

function closeReminder() {
  document.getElementById('popup-reminder').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  alarmSound.pause();
  if (isLooping) startReminderTimer();
}

function goToExercises() {
  document.getElementById('popup-reminder').style.display = 'none';
  alarmSound.pause();
  document.getElementById('exercise-screen').style.display = 'flex';
}

function finishExercises() {
  document.getElementById('exercise-screen').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  for(let i=1; i<=totalExercises; i++) document.getElementById(`vid${i}`).pause();
  if (isLooping) startReminderTimer();
}

function changeExercise(dir) {
    document.getElementById(`ex${currentEx}`).classList.remove('active');
    document.getElementById(`vid${currentEx}`).pause();
    currentEx += dir;
    if (currentEx > totalExercises) currentEx = 1;
    if (currentEx < 1) currentEx = totalExercises;
    document.getElementById(`ex${currentEx}`).classList.add('active');
}
</script>
</body>
</html>
