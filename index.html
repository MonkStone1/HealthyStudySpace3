<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HealthyStudySpace AI: –ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞ –¥–ª—è –æ—á–µ–π</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>

  <style>
    /* --- –û–°–ù–û–í–ù–ò–ô –°–¢–ò–õ–¨ --- */
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #75cfca, #59b7b2);
      text-align: center;
      margin: 0; padding: 0;
      color: #333; overflow-x: hidden;
      min-height: 100vh;
    }

    h2 { margin-top: 20px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    .container {
      margin-top: 20px;
      display: inline-block;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      position: relative;
      visibility: hidden;
    }

    canvas {
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      max-width: 100%; height: auto;
    }

    #status {
      margin-top: 15px; font-size: 1.3em; font-weight: 600;
      padding: 10px; border-radius: 10px;
    }
    #status.good { color: #2e7d32; background: #e8f5e9; }
    #status.bad { color: #c62828; background: #ffebee; }
    #status.neutral { color: #555; background: #f5f5f5; }

    /* --- –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê --- */
    .modal {
      display: none; 
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      text-align: left;
      width: 360px;
      z-index: 1000;
      animation: popIn 0.3s ease-out;
    }
    #settings-modal { display: block; }

    @keyframes popIn {
      from { transform: translate(-50%, -60%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }

    .modal h3 { margin-top: 0; text-align: center; color: #00796b; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .modal h4 { margin: 15px 0 5px 0; color: #004d40; font-size: 1.1em; }

    .input-group { margin-bottom: 15px; }
    .input-row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    
    input[type="number"] { padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 60px; }
    select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .btn {
      width: 100%; margin-top: 15px; padding: 12px;
      border-radius: 8px; border: none; cursor: pointer;
      font-weight: bold; font-size: 1rem; transition: 0.2s;
    }
    .btn-primary { background: #00796b; color: white; }
    .btn-primary:hover { background: #004d40; }
    .btn-close { background: #eee; color: #333; }

    /* --- –ï–ö–†–ê–ù –í–ü–†–ê–í --- */
    #exercise-screen {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, #75cfca, #59b7b2);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }

    .slider-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 850px;
    }

    .exercise-card {
      background: white;
      width: 90%;
      max-width: 600px;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      text-align: center;
      display: none;
      animation: slideIn 0.4s ease-out;
    }

    .exercise-card.active { display: block; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .nav-btn {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      font-size: 2.5rem;
      cursor: pointer;
      padding: 20px;
      border-radius: 50%;
      transition: 0.3s;
      margin: 0 10px;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.5); }

    video {
      border-radius: 15px;
      background: #000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .instruction-text {
      font-size: 1.1em;
      color: #444;
      background: #e0f2f1;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }

    #overlay {
      display: block; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      z-index: 999;
    }
  </style>
</head>
<body>

<h2>HealthyStudySpace AI</h2>

<div class="container" id="main-container">
  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="status" class="neutral">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è...</div>
</div>

<div id="overlay"></div>

<div id="settings-modal" class="modal">
  <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
  
  <h4>‚è∞ –¢–∞–π–º–µ—Ä —Ä–æ–∑–º–∏–Ω–∫–∏</h4>
  <div class="input-group">
    <div class="input-row">
      <span>–ù–∞–≥–∞–¥—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑:</span>
      <div>
        <input type="number" id="timeValue" value="10" min="1">
        <select id="timeUnit"><option value="sec">–°–µ–∫</option><option value="min">–•–≤</option></select>
      </div>
    </div>
    <div class="input-row" style="margin-top: 8px;">
      <label style="display:flex; align-items:center; cursor:pointer;">
        <input type="checkbox" id="loopCheck" checked>
        <span style="margin-left:8px;">–ü–æ—Å—Ç—ñ–π–Ω–∏–π —Ü–∏–∫–ª</span>
      </label>
    </div>
  </div>

  <hr style="border:0; border-top:1px solid #eee;">

  <h4>‚ö†Ô∏è –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Å—Ç–∞–≤–∏</h4>
  <div class="input-group">
    <div class="input-row">
      <span>–ß–∞—Å –¥–æ —Å–∏–≥–Ω–∞–ª—É (—Å–µ–∫):</span>
      <input type="number" id="postureDelayInput" value="5" min="1">
    </div>
    <div class="input-row" style="margin-top: 8px;">
      <label style="display:flex; align-items:center; cursor:pointer;">
        <input type="checkbox" id="postureSoundCheck" checked>
        <span style="margin-left:8px;">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ –ø–æ–º–∏–ª–∫–∏</span>
      </label>
    </div>
  </div>

  <button class="btn btn-primary" onclick="startSystem()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
</div>

<div id="popup-reminder" class="modal">
  <h3>üîî –ß–∞—Å —Ä–æ–∑—ñ–º'—è—Ç–∏—Å—å!</h3>
  <p>–í–∏ –ø—Ä–∞—Ü—é—î—Ç–µ –≤–∂–µ –¥–æ–≤–≥–æ.<br>–ó—Ä–æ–±—ñ—Ç—å –≤–ø—Ä–∞–≤–∏ –¥–ª—è –æ—á–µ–π.</p>
  <div style="display:flex; justify-content: center; gap: 10px;">
      <button class="btn btn-close" style="width:auto;" onclick="closeReminder()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
      <button class="btn btn-primary" style="width:auto;" onclick="goToExercises()">–î–æ –≤–ø—Ä–∞–≤</button>
  </div>
</div>

<div id="exercise-screen">
  <div class="slider-container">
    <button class="nav-btn" onclick="changeExercise(-1)">‚ùÆ</button>

    <div class="exercise-card active" id="ex1">
      <h3 style="color:#00796b">–í–ø—Ä–∞–≤–∞ 1: –ß–∞—Å—Ç–µ –∫–ª—ñ–ø–∞–Ω–Ω—è</h3>
      <video width="100%" height="auto" controls loop id="vid1">
        <source src="Blink_eyes.mp4" type="video/mp4">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–µ–æ.
      </video>
      <div class="instruction-text">
        –®–≤–∏–¥–∫–æ —ñ –ª–µ–≥–∫–æ –∫–ª—ñ–ø–∞–π—Ç–µ –æ—á–∏–º–∞ –ø—Ä–æ—Ç—è–≥–æ–º 1-2 —Ö–≤–∏–ª–∏–Ω.<br>
        –¶–µ –ø–æ–∫—Ä–∞—â—É—î –∫—Ä–æ–≤–æ–æ–±—ñ–≥ —ñ –∑–≤–æ–ª–æ–∂—É—î –æ—á—ñ.
      </div>
      <button class="btn btn-primary" onclick="finishExercises()">‚úÖ –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
    </div>

    <div class="exercise-card" id="ex2">
      <h3 style="color:#00796b">–í–ø—Ä–∞–≤–∞ 2: –ú—ñ—Ü–Ω–µ –∑–∞–ø–ª—é—â–µ–Ω–Ω—è</h3>
      <video width="100%" height="auto" controls loop id="vid2">
        <source src="Long_blind.mp4" type="video/mp4">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–µ–æ.
      </video>
      <div class="instruction-text">
        –ú—ñ—Ü–Ω–æ –∑–∞–ø–ª—é—â—Ç–µ –æ—á—ñ –Ω–∞ 3-5 —Å–µ–∫—É–Ω–¥, –ø–æ—Ç—ñ–º –≤—ñ–¥–∫—Ä–∏–π—Ç–µ.<br>
        –î–æ–ø–æ–º–∞–≥–∞—î –∑–Ω—è—Ç–∏ –Ω–∞–ø—Ä—É–≥—É –∑ –æ—á–Ω–∏—Ö –º'—è–∑—ñ–≤.
      </div>
      <button class="btn btn-primary" onclick="finishExercises()">‚úÖ –ó–∞–∫—ñ–Ω—á–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
    </div>

    <button class="nav-btn" onclick="changeExercise(1)">‚ùØ</button>
  </div>
</div>

<script>
// --- –ü–û–í–ù–ò–ô –§–£–ù–ö–¶–Ü–û–ù–ê–õ –°–ö–†–ò–ü–¢–ê ---
let reminderIntervalMs = 10000, isLooping = true, badPostureDelayMs = 5000, isPostureSoundEnabled = true;
let detector, video, canvas, ctx, statusText, timerId, lastPoses = [], lastAnalysisTime = 0, isProcessingAi = false, badPostureStart = null;
const detectionIntervalMs = 100;
const alarmSound = new Audio("https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg");
const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

// –õ–æ–≥—ñ–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
let currentEx = 1;
function changeExercise(dir) {
    document.getElementById(`ex${currentEx}`).classList.remove('active');
    document.getElementById(`vid${currentEx}`).pause(); // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î
    
    currentEx = currentEx + dir;
    if (currentEx > 2) currentEx = 1;
    if (currentEx < 1) currentEx = 2;
    
    document.getElementById(`ex${currentEx}`).classList.add('active');
    // –ù–µ –∑–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ muted, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º—ñ–≥ —Å–∞–º –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ Play —É –ø–ª–µ—î—Ä—ñ
    // –∞–±–æ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ .play() —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
}

function startSystem() {
  reminderIntervalMs = (document.getElementById('timeUnit').value === 'min' ? 60000 : 1000) * parseInt(document.getElementById('timeValue').value);
  isLooping = document.getElementById('loopCheck').checked;
  badPostureDelayMs = parseInt(document.getElementById('postureDelayInput').value) * 1000;
  isPostureSoundEnabled = document.getElementById('postureSoundCheck').checked;

  document.getElementById('settings-modal').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('main-container').style.visibility = 'visible';
  init();
}

async function init() {
  canvas = document.getElementById("canvas"); ctx = canvas.getContext("2d");
  statusText = document.getElementById("status");
  statusText.textContent = "üöÄ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AI...";
  
  await tf.setBackend("webgl");
  detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);
  
  video = document.createElement("video");
  const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
  video.srcObject = stream;
  await video.play();
  
  statusText.textContent = "‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞";
  startReminderTimer();
  renderLoop();
}

function startReminderTimer() {
  if (timerId) clearTimeout(timerId);
  timerId = setTimeout(() => {
    document.getElementById('popup-reminder').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
    alarmSound.play().catch(()=>{});
  }, reminderIntervalMs);
}

function closeReminder() {
  document.getElementById('popup-reminder').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  alarmSound.pause();
  if (isLooping) startReminderTimer();
}

function goToExercises() {
  document.getElementById('popup-reminder').style.display = 'none';
  document.getElementById('exercise-screen').style.display = 'flex';
  alarmSound.pause();
}

function finishExercises() {
  document.getElementById('exercise-screen').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('vid1').pause();
  document.getElementById('vid2').pause();
  if (isLooping) startReminderTimer();
}

function renderLoop() {
  ctx.drawImage(video, 0, 0, 640, 480);
  const now = Date.now();
  const hidden = document.getElementById('exercise-screen').style.display === 'flex' || document.getElementById('popup-reminder').style.display === 'block';

  if (!isProcessingAi && !hidden && (now - lastAnalysisTime > detectionIntervalMs)) {
    isProcessingAi = true;
    detector.estimatePoses(video).then(poses => {
      lastPoses = poses;
      analyze(poses);
      isProcessingAi = false;
      lastAnalysisTime = now;
    });
  }
  if (!hidden) drawSkeleton(lastPoses);
  requestAnimationFrame(renderLoop);
}

function analyze(poses) {
  if (!poses.length) return;
  const kp = poses[0].keypoints;
  const L = kp.find(p => p.name === "left_shoulder"), R = kp.find(p => p.name === "right_shoulder");
  
  let bad = false;
  if (L?.score > 0.3 && R?.score > 0.3) {
    if (Math.abs(L.y - R.y) > 20) bad = true;
  }

  if (bad) {
    if (!badPostureStart) badPostureStart = Date.now();
    if (Date.now() - badPostureStart > badPostureDelayMs) {
      statusText.textContent = "‚ö†Ô∏è –í–∏—Ä—ñ–≤–Ω—è–π—Ç–µ —Å–ø–∏–Ω—É!";
      statusText.className = "bad";
      if (isPostureSoundEnabled) beep.play().catch(()=>{});
    }
  } else {
    badPostureStart = null;
    statusText.textContent = "‚úÖ –ß—É–¥–æ–≤–∞ –ø–æ—Å—Ç–∞–≤–∞!";
    statusText.className = "good";
  }
}

function drawSkeleton(poses) {
  if (!poses.length) return;
  const kp = poses[0].keypoints;
  const L = kp.find(p => p.name === "left_shoulder"), R = kp.find(p => p.name === "right_shoulder");
  if (L?.score > 0.3 && R?.score > 0.3) {
    ctx.beginPath(); ctx.moveTo(L.x, L.y); ctx.lineTo(R.x, R.y);
    ctx.lineWidth = 6; ctx.strokeStyle = (statusText.className === "good") ? "#00e676" : "#ff1744";
    ctx.stroke();
  }
}
</script>
</body>
</html>
